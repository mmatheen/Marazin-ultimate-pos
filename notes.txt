This query is fetch All dublicated Item Found
for Gel All record sale id based and batch id based and location_batch  id based fetch the record

-- Step 1: Get location_batch_id for each batch used in this sale
WITH loc_batches AS (
    SELECT 
        lb.id AS location_batch_id,
        lb.batch_id,
        lb.location_id,
        lb.qty
    FROM location_batches lb
    JOIN sales_products sp ON sp.batch_id = lb.batch_id
    WHERE sp.sale_id = 1932
      AND sp.product_id = 3616
      AND lb.batch_id IN (3073, 4662)
),

-- Step 2: Get stock history for those location batches
stock_history_records AS (
    SELECT 
        sh.id AS stock_history_id,
        sh.loc_batch_id,
        sh.quantity,
        sh.stock_type,
        sh.created_at
    FROM stock_histories sh
    WHERE sh.loc_batch_id IN (SELECT location_batch_id FROM loc_batches)
)

-- Final Output
SELECT 
    lb.location_batch_id,
    lb.batch_id,
    lb.location_id,
    lb.qty AS batch_stock_qty,
    sh.stock_history_id,
    sh.quantity AS stock_history_quantity,
    sh.stock_type,
    sh.created_at AS stock_history_date
FROM loc_batches lb
LEFT JOIN stock_history_records sh ON lb.location_batch_id = sh.loc_batch_id
ORDER BY lb.batch_id;

then update

-- Update sales_products based on matching stock_histories
UPDATE sales_products sp
JOIN stock_histories sh ON sp.batch_id = sh.loc_batch_id
SET sp.quantity = ABS(sh.quantity)
WHERE sh.id IN (8798, 8799);


SELECT * FROM sales_products WHERE sale_id = 1932 AND product_id = 3616;